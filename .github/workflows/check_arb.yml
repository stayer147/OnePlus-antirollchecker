name: Check ARB

on:
  workflow_dispatch:
    inputs:
      force_recheck:
        description: 'Force recheck all firmwares even if already checked'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 0 * * *' # Run daily

jobs:
  check-variant:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        device: [oneplus_15, oneplus_15r, oneplus_13, oneplus_12]
        variant: [GLO, EU, IN, CN]
        exclude:
          - device: oneplus_15r
            variant: CN
        include:
          - device: oneplus_15
            device_short: "15"
            device_name: "OnePlus 15"
          - device: oneplus_15r
            device_short: "15R"
            device_name: "OnePlus 15R"
          - device: oneplus_13
            device_short: "13"
            device_name: "OnePlus 13"
          - device: oneplus_12
            device_short: "12"
            device_name: "OnePlus 12"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 unzip curl python3-pip
          pip3 install requests beautifulsoup4 --break-system-packages || pip3 install requests beautifulsoup4

      - name: Setup Tools
        run: |
          mkdir -p tools
          
          # Setup arbextract
          curl -L -o tools/arbextract https://github.com/koaaN/arbextract/releases/download/1.0/arbextract-x86_64-linux
          chmod +x tools/arbextract
          
          # Setup payload-dumper-go
          curl -L -o payload-dumper.tar.gz https://github.com/ssut/payload-dumper-go/releases/download/1.3.0/payload-dumper-go_1.3.0_linux_amd64.tar.gz
          tar -xzvf payload-dumper.tar.gz -C tools
          find tools -name "payload-dumper-go" -type f -exec mv {} tools/payload-dumper \;
          chmod +x tools/payload-dumper
          
      - name: Get Firmware Details
        id: get_details
        run: |
          # Unified fetching logic using fetch_firmware.py
          # It handles OOS API priority and Springer fallback
          
          echo "Fetching details for ${{ matrix.device }} ${{ matrix.variant }}..."
          
          # Use --output file to avoid log contamination in stdout
          python3 fetch_firmware.py "${{ matrix.device }}" "${{ matrix.variant }}" --output fw_info.json
          
          if [ ! -f fw_info.json ]; then
             echo "Failed to fetch firmware details (no output file)"
             exit 1
          fi
          
          URL=$(python3 -c "import sys, json; print(json.load(open('fw_info.json'))['url'])")
          VERSION=$(python3 -c "import sys, json; print(json.load(open('fw_info.json'))['version'])")
          
          echo "Device: ${{ matrix.device_name }}"
          echo "Variant: ${{ matrix.variant }}"
          echo "Latest Firmware URL: $URL"
          echo "Latest Firmware Version: $VERSION"
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "device_short=${{ matrix.device_short }}" >> $GITHUB_OUTPUT

      - name: Restore ARB Cache
        id: cache-arb
        if: github.event.inputs.force_recheck != 'true'
        uses: actions/cache/restore@v4
        with:
          path: |
            arb_check_done.txt
            extracted/
          # Cache key includes device and variant to be separate
          key: arb-check-v6-${{ matrix.device }}-${{ matrix.variant }}-${{ steps.get_details.outputs.version }}

      - name: Download Firmware
        if: steps.cache-arb.outputs.cache-hit != 'true'
        run: |
          URL="${{ steps.get_details.outputs.url }}"
          
          if [[ "${{ matrix.variant }}" == "CN" ]]; then
            echo "Downloading CN firmware with robust retry loop..."
            
            MAX_RETRIES=5
            RETRY_COUNT=0
            SUCCESS=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempting download (Try $((RETRY_COUNT+1))/$MAX_RETRIES)..."
              echo "URL: $URL"
              
              # Use -c to continue. Increased concurrency to -x16 -s16 as requested for speed.
              if aria2c -c -x16 -s16 -k1M -o firmware.zip "$URL"; then
                echo "Download successful!"
                SUCCESS=1
                break
              fi
              
              echo "Download failed. Refreshing signed URL..."
              RETRY_COUNT=$((RETRY_COUNT+1))
              
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "Max retries reached."
                break
              fi
              
              # Refresh URL for the SPECIFIC version we started with
              # We use 'fw_refresh.json' to distinct from original 'fw_info.json'
              python3 fetch_firmware.py "${{ matrix.device }}" "${{ matrix.variant }}" "$VERSION" --output fw_refresh.json
              
              if [ -f fw_refresh.json ]; then
                 NEW_URL=$(python3 -c "import sys, json; print(json.load(open('fw_refresh.json'))['url'])")
                 if [[ "$NEW_URL" != "" && "$NEW_URL" != "null" ]]; then
                    URL="$NEW_URL"
                    echo "Refreshed URL successfully."
                 else
                    echo "Failed to extract new URL from refresh output."
                 fi
              else
                 echo "Failed to refresh URL (script failed)."
                 cat fw_refresh.json || echo "No stderr output captured."
              fi
              
              # Small delay before retry
              sleep 5
            done
            
            if [ $SUCCESS -eq 0 ]; then
               echo "Download failed after all attempts."
               touch skip_check.txt
            fi
            
          elif [[ "$URL" == *".zip"* ]]; then
            echo "Downloading ZIP firmware..."
            aria2c -x16 -s16 -k1M -o firmware.zip "$URL" || touch skip_check.txt
          else
            echo "Skipping non-direct download link: $URL"
            touch skip_check.txt
          fi

      - name: Analyze Firmware (Check ARB)
        if: steps.cache-arb.outputs.cache-hit != 'true' && hashFiles('skip_check.txt') == ''
        run: |
          # Use the new standalone script
          python3 analyze_firmware.py firmware.zip --tools-dir tools --output-dir extracted --json > result.json
          
          # Inject extra metadata into result.json for update_history.py
          # (We could have passed these to analyze_firmware.py, but it's pure analysis)
          # Let's just use jq or python to merge? Or just pass arguments to update_history.py explicitly
          # Update: update_history.py accepts --json-file and missing args separate.
          # We need to make sure result.json has device_short, variant, version if we assume --json-file provides all.
          # But analyze_firmware.py only outputs ARB info.
          # So we will pass the rest as args.
          
          cat result.json

      - name: Update JSON History (Current Version)
        if: hashFiles('result.json') != ''
        run: |
          python3 update_history.py \
            "${{ steps.get_details.outputs.device_short }}" \
            "${{ matrix.variant }}" \
            "${{ steps.get_details.outputs.version }}" \
            --json-file result.json

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.device }}-${{ matrix.variant }}
          path: result.json
      
      - name: Save ARB Cache
        if: steps.cache-arb.outputs.cache-hit != 'true' && hashFiles('extracted/xbl_config.img') != ''
        uses: actions/cache/save@v4
        with:
          path: |
            arb_check_done.txt
            extracted/
          key: arb-check-v6-${{ matrix.device }}-${{ matrix.variant }}-${{ steps.get_details.outputs.version }}

      - name: Upload JSON History
        uses: actions/upload-artifact@v4
        with:
          name: history-${{ matrix.device }}-${{ matrix.variant }}
          path: data/history/${{ steps.get_details.outputs.device_short }}_${{ matrix.variant }}.json

      - name: Cleanup
        if: always()
        run: rm -f firmware.zip

  update-readme:
    needs: check-variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
      
      - name: Restore History & Generate README
        run: |
          mkdir -p data/history
          
          # Restore JSONs
          find artifacts -name 'history-*' -type d | while read dir; do
            JSON_FILE=$(find "$dir" -name '*.json' | head -n 1)
            if [ -f "$JSON_FILE" ]; then
              cp "$JSON_FILE" data/history/
            fi
          done
          
          # Generate
          python3 generate_readme.py
          
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/history/*.json README.md
          git commit -m "Update ARB history and README" || echo "No changes to commit"
          git push
